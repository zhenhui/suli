/**
 * Created by 松松 on 13-11-26.
 */

var app = require('app')
var gm = require('gm')
var path = require('path')
var fs = require('fs')

app.get('/captcha', function (req, res) {
    var fileName = Math.random() + '' + req.sessionID + Date.now()
    var code = parseInt(Math.random() * 10000, 10).toString().substring(0, 5)
    var newPath = path.join(__dirname, fileName + '.gif')
    res.header('Cache-control', 'no-cache;  must-revalidate')
    res.header('Expires', '-1');
    res.header('Last-Modified', ' Tue, 10 Jan 2000 02:19:00 GMT');
    res.header('Pragma', 'no-cache');

    var text = String.fromCharCode(getRand(65, 90)) +
        String.fromCharCode(getRand(65, 90)) +
        String.fromCharCode(getRand(65, 90)) +
        String.fromCharCode(getRand(65, 90))
    req.session.captcha = text.toLowerCase()
    gm(80, 30, "#ffffff")
        .stroke('#333333', 1)
        .drawLine(getRand(20, 80), getRand(0, 30), getRand(0, 80), getRand(0, 30))
        .drawLine(getRand(20, 80), getRand(0, 30), getRand(0, 80), getRand(0, 30))
        .drawLine(getRand(20, 80), getRand(0, 30), getRand(0, 80), getRand(0, 30))
        .drawLine(getRand(0, 80), getRand(0, 25), getRand(0, 50), getRand(0, 30))
        .drawLine(getRand(0, 80), getRand(0, 25), getRand(0, 50), getRand(0, 30))
        .swirl(getRand(100, 252))
        .font('Verdana')
        .fontSize(24)
        .drawText(0, 23, text)
        .swirl(getRand(3, 10))
        .write(newPath, function (err) {
            res.sendfile(newPath, function () {
                fs.unlink(newPath)
            })
        });
})

function getRand(a, b) {
    return parseInt(Math.random() * 100, 10) % (b - a + 1) + a
}