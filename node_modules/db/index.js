var mongodb = require('mongodb');
var server = new mongodb.Server("localhost", 27017, {safe: true});
var fed = new mongodb.Db('suli', server, {journal: true});

exports.mongodb = mongodb;

exports.dbServer = fed;

exports.Collection = mongodb.Collection;

//当数据库连接成功后，需要执行的一些回调
//例如：需要在第一时间缓存好某些数据
exports._cache = [];

exports.open = function () {
    fed.open(function (error, client) {
        if (!error) {
            exports.Client = client;
            //将队列中存在的函数列表全部执行一次。
            exports._cache.forEach(function (fn) {
                fn();
            });
            delete exports._cache;
        }
        console.log(!error ? '数据库连接成功' : '无法连接数据库')
    });
};

fed.on('close', function () {
    console.log('Database connection is disconnected!\t' + new Date().toLocaleTimeString());
});

exports.open();

//数据库连接成功后的回调
exports.on_db_opened_cb = function (fn) {
    //如果数据库已经连接成功，则马上执行回调
    if (exports.client) {
        fn();
    } else {
        //否则存起来，待数据库open后方执行
        exports._cache.push(fn);
    }
};
